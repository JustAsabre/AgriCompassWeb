# üîê CSRF Secret Setup Guide - Step by Step

## üìã What is CSRF_SECRET?

**CSRF_SECRET** is a cryptographic key used to sign and verify CSRF tokens. It ensures that tokens generated by your server cannot be forged by attackers.

**Security Level:** High Priority üî¥
- Must be **random** and **unpredictable**
- Must be **at least 32 characters**
- Should be **different from SESSION_SECRET** (but can fallback to it)

---

## üéØ Quick Setup (Copy & Paste)

### Option 1: Using PowerShell (Windows)

```powershell
# Step 1: Generate a secure random secret
$csrfSecret = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 32 | ForEach-Object {[char]$_})
$sessionSecret = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 32 | ForEach-Object {[char]$_})

# Step 2: Display the secrets (copy these)
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "GENERATED SECRETS - COPY THESE!" -ForegroundColor Yellow
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "SESSION_SECRET=$sessionSecret" -ForegroundColor Green
Write-Host "CSRF_SECRET=$csrfSecret" -ForegroundColor Green
Write-Host "========================================`n" -ForegroundColor Cyan

# Step 3: Copy secrets to clipboard (optional)
"SESSION_SECRET=$sessionSecret`nCSRF_SECRET=$csrfSecret" | Set-Clipboard
Write-Host "‚úÖ Secrets copied to clipboard!" -ForegroundColor Green
```

**Output Example:**
```
========================================
GENERATED SECRETS - COPY THESE!
========================================
SESSION_SECRET=k8Jx2mQpL9vN4wRt6YhZu3Gc5Fa7Eb0D
CSRF_SECRET=a2Bc4De6Fg8Hi0Jk1Lm3No5Pq7Rs9Tu1
========================================
```

---

### Option 2: Using OpenSSL (Linux/Mac/WSL)

```bash
# Generate SESSION_SECRET
openssl rand -base64 32

# Generate CSRF_SECRET
openssl rand -base64 32

# Or generate both at once
echo "SESSION_SECRET=$(openssl rand -base64 32)"
echo "CSRF_SECRET=$(openssl rand -base64 32)"
```

**Output Example:**
```
SESSION_SECRET=k8Jx2mQpL9vN4wRt6YhZu3Gc5Fa7Eb0D1bVcXzAqWeRt
CSRF_SECRET=a2Bc4De6Fg8Hi0Jk1Lm3No5Pq7Rs9Tu1Vw3Xy5Za7Bc
```

---

### Option 3: Using Node.js

```javascript
// Run in Node.js REPL or save as generate-secrets.js
const crypto = require('crypto');

console.log('SESSION_SECRET=' + crypto.randomBytes(32).toString('base64'));
console.log('CSRF_SECRET=' + crypto.randomBytes(32).toString('base64'));
```

```bash
# Run it
node -e "const crypto = require('crypto'); console.log('SESSION_SECRET=' + crypto.randomBytes(32).toString('base64')); console.log('CSRF_SECRET=' + crypto.randomBytes(32).toString('base64'));"
```

---

## üöÄ Setting Secrets on Fly.io

### Step 1: Install Fly CLI (if not already installed)

```powershell
# Windows PowerShell (Run as Administrator)
iwr https://fly.io/install.ps1 -useb | iex

# Verify installation
fly version
```

### Step 2: Login to Fly.io

```powershell
fly auth login
```

A browser window will open for authentication.

### Step 3: Set CSRF Secret

**Method A: Set Individual Secret**
```powershell
fly secrets set CSRF_SECRET="<your-generated-csrf-secret>" -a agricompassweb
```

**Method B: Set All Secrets at Once** (Recommended)
```powershell
# Generate secrets first (using PowerShell method above)
# Then set all secrets in one command:

fly secrets set `
  SESSION_SECRET="<your-session-secret>" `
  CSRF_SECRET="<your-csrf-secret>" `
  DATABASE_URL="<your-neon-postgres-url>" `
  FRONTEND_URL="https://agricompass.vercel.app" `
  SMTP_HOST="smtp.gmail.com" `
  SMTP_PORT="587" `
  SMTP_USER="<your-gmail>" `
  SMTP_PASS="<your-app-password>" `
  SMTP_SERVICE="gmail" `
  PAYSTACK_SECRET_KEY="<your-paystack-key>" `
  PAYSTACK_WEBHOOK_SECRET="<your-webhook-secret>" `
  REDIS_URL="<your-upstash-redis-url>" `
  -a agricompassweb
```

### Step 4: Verify Secrets Are Set

```powershell
# List all secrets (values are hidden for security)
fly secrets list -a agricompassweb
```

**Expected Output:**
```
NAME                      DIGEST                  CREATED AT
CSRF_SECRET               abc123def456...         2025-12-18T...
SESSION_SECRET            xyz789uvw012...         2025-12-18T...
DATABASE_URL              mno345pqr678...         2025-12-18T...
FRONTEND_URL              stu901vwx234...         2025-12-18T...
...
```

### Step 5: Deploy

```powershell
# Deploy to apply secrets
fly deploy -a agricompassweb

# Watch logs to verify CSRF is enabled
fly logs -a agricompassweb
```

**Look for this in logs:**
```
CSRF protection ENABLED using double submit cookie pattern
```

---

## üîí Local Development Setup

### For .env File (Local Development)

Create or edit `.env` in project root:

```bash
# Generate secrets using PowerShell or OpenSSL methods above
SESSION_SECRET=k8Jx2mQpL9vN4wRt6YhZu3Gc5Fa7Eb0D
CSRF_SECRET=a2Bc4De6Fg8Hi0Jk1Lm3No5Pq7Rs9Tu1

# Other local dev settings
DATABASE_URL=postgresql://localhost:5432/agricompass
FRONTEND_URL=http://localhost:5000
NODE_ENV=development
```

**Security Note:** 
- ‚ö†Ô∏è **Never commit `.env` to git!** (already in `.gitignore`)
- ‚úÖ Use different secrets for dev and production
- ‚úÖ Rotate secrets periodically

---

## üìã Complete Secrets Checklist

### Required for Production:

```bash
# Core Security (MUST SET - Generate above)
‚úÖ SESSION_SECRET=<32+ random characters>
‚úÖ CSRF_SECRET=<32+ random characters>

# Database (From Neon Dashboard)
‚úÖ DATABASE_URL=postgresql://user:pass@host.neon.tech/dbname

# Frontend URL (For email links)
‚úÖ FRONTEND_URL=https://agricompass.vercel.app

# Email (Gmail App Password)
‚úÖ SMTP_HOST=smtp.gmail.com
‚úÖ SMTP_PORT=587
‚úÖ SMTP_SECURE=false
‚úÖ SMTP_USER=your-email@gmail.com
‚úÖ SMTP_PASS=<16-char-app-password>
‚úÖ SMTP_SERVICE=gmail

# Payments (From Paystack Dashboard)
‚úÖ PAYSTACK_SECRET_KEY=sk_live_xxxxx
‚úÖ PAYSTACK_WEBHOOK_SECRET=<from-paystack>

# Session Store (Optional but Recommended)
‚ö†Ô∏è REDIS_URL=redis://:password@host.upstash.io:6379

# Monitoring (Optional)
‚≠ï SENTRY_DSN=https://...
```

---

## üß™ Testing CSRF Protection

### After Deployment:

```powershell
# 1. Get CSRF token (should work)
Invoke-RestMethod -Uri "https://agricompass.vercel.app/api/csrf-token"

# Output: { "csrfToken": "long-random-string..." }
```

```javascript
// 2. Test in browser console
// Auth routes work WITHOUT token
fetch('/api/auth/login', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({email: 'test@test.com', password: 'test123'})
})

// 3. Protected routes REQUIRE token
fetch('/api/user', {
  method: 'PATCH',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({fullName: 'Test'})
}) // Should fail with 403 Forbidden

// 4. Get token and retry
fetch('/api/csrf-token')
  .then(r => r.json())
  .then(d => fetch('/api/user', {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': d.csrfToken
    },
    body: JSON.stringify({fullName: 'Test'})
  })) // Should succeed
```

---

## üõ°Ô∏è Security Best Practices

### ‚úÖ DO:
- Use cryptographically secure random generation
- Use at least 32 characters
- Keep secrets in environment variables (never in code)
- Use different secrets for dev/staging/production
- Rotate secrets every 90 days
- Store secrets in secure password manager

### ‚ùå DON'T:
- Use predictable values (e.g., "mysecret123")
- Commit secrets to git
- Share secrets in Slack/Email
- Use same secret across environments
- Use passwords or dictionary words
- Reuse SESSION_SECRET as CSRF_SECRET (but fallback is OK)

---

## üîÑ Secret Rotation (Every 90 Days)

```powershell
# 1. Generate new secrets
$newCsrfSecret = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 32 | ForEach-Object {[char]$_})

# 2. Update on Fly.io
fly secrets set CSRF_SECRET="$newCsrfSecret" -a agricompassweb

# 3. Deploy
fly deploy -a agricompassweb

# Note: Old sessions will be invalidated (users will need to re-login)
```

---

## üÜò Troubleshooting

### Issue: "CSRF validation failed"

**Solution:**
1. Verify `CSRF_SECRET` is set: `fly secrets list -a agricompassweb`
2. Check logs: `fly logs -a agricompassweb | Select-String "CSRF"`
3. Ensure `FRONTEND_URL` matches your Vercel domain exactly
4. Clear browser cookies and retry

### Issue: Secrets not applying

**Solution:**
```powershell
# Secrets require a deployment to take effect
fly deploy -a agricompassweb

# Force restart if needed
fly apps restart agricompassweb
```

### Issue: Lost/forgot secrets

**Solution:**
- Generate new secrets and update
- All users will need to re-login
- Update any external services using the old secrets

---

## üìö Additional Resources

- **Fly.io Secrets Docs:** https://fly.io/docs/reference/secrets/
- **OWASP CSRF Guide:** https://owasp.org/www-community/attacks/csrf
- **Node.js Crypto:** https://nodejs.org/api/crypto.html

---

**Version:** 1.9.0  
**Date:** December 18, 2025  
**Status:** ‚úÖ Ready to Generate and Set Secrets
